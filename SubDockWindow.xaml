<Window x:Class="NexusDock.SubDockWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:NexusDock"
        Title="SubDock" 
        Height="300" 
        Width="300"
        SizeToContent="Manual" 
        WindowStartupLocation="Manual"
        WindowStyle="None" 
        AllowsTransparency="True" 
        Background="Transparent"
        Topmost="True"
        ShowInTaskbar="False"
        Loaded="Window_Loaded"
        Deactivated="Window_Deactivated"
        Opacity="0">

    <Window.Resources>
        <Style TargetType="ContextMenu">
            <Setter Property="Background" Value="#1E1E1E"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderBrush" Value="#444"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ContextMenu">
                        <Border Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}" CornerRadius="5" Padding="5">
                            <StackPanel IsItemsHost="True"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style TargetType="MenuItem">
            <Setter Property="Header" Value="{Binding Header}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="MenuItem">
                        <Grid>
                            <Border x:Name="Border" Background="Transparent" Padding="{TemplateBinding Padding}" CornerRadius="3">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="20"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <Path x:Name="CheckMark" Data="M 2,5 L 5,8 L 12,1" Stroke="White" StrokeThickness="2" Visibility="Collapsed" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                    <ContentPresenter Grid.Column="1" Content="{TemplateBinding Header}" VerticalAlignment="Center"/>
                                    <Path x:Name="Arrow" Grid.Column="2" Data="M 0,0 L 4,3.5 L 0,7" Stroke="#E0E0E0" StrokeThickness="1" Margin="10,0,0,0" VerticalAlignment="Center" Visibility="Collapsed"/>
                                </Grid>
                            </Border>
                            <Popup x:Name="Popup" Placement="Right" IsOpen="{TemplateBinding IsSubmenuOpen}" AllowsTransparency="True" Focusable="False" PopupAnimation="Fade">
                                <Border Background="#1E1E1E" BorderBrush="#444" BorderThickness="1" CornerRadius="5" Padding="5">
                                    <StackPanel IsItemsHost="True" KeyboardNavigation.DirectionalNavigation="Cycle"/>
                                </Border>
                            </Popup>
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsHighlighted" Value="True">
                                <Setter TargetName="Border" Property="Background" Value="#3E3E3E"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="CheckMark" Property="Visibility" Value="Visible"/>
                            </Trigger>
                            <Trigger Property="Role" Value="SubmenuHeader">
                                <Setter TargetName="Arrow" Property="Visibility" Value="Visible"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style TargetType="ScrollBar">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Width" Value="8"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ScrollBar">
                        <Grid>
                            <Border Background="Transparent"/>
                            <Track Name="PART_Track" IsDirectionReversed="true">
                                <Track.Thumb>
                                    <Thumb>
                                        <Thumb.Template>
                                            <ControlTemplate TargetType="Thumb">
                                                <Border Background="#555" CornerRadius="4"/>
                                            </ControlTemplate>
                                        </Thumb.Template>
                                    </Thumb>
                                </Track.Thumb>
                            </Track>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <DataTemplate x:Key="GridViewTemplate">
            <Button Click="SubAppButton_Click"
                    PreviewMouseLeftButtonDown="SubAppButton_PreviewMouseLeftButtonDown"
                    PreviewMouseMove="SubAppButton_PreviewMouseMove"
                    DragOver="SubAppButton_DragOver"
                    Drop="SubAppButton_Drop"
                    AllowDrop="True"
                    Margin="5"
                    Background="Transparent"
                    BorderBrush="Transparent"
                    ToolTipService.InitialShowDelay="50"
                    ToolTipService.ShowDuration="10000">
                <Button.ContextMenu>
                    <ContextMenu>
                        <MenuItem Header="Uruchom" Click="SubAppButton_Click"/>
                        <MenuItem Header="Uruchom jako Administrator" Click="RunAsAdmin_Click"/>
                        <Separator Background="#444" Margin="0,5"/>
                        <MenuItem Header="Otwórz lokalizację pliku" Click="OpenFileLocation_Click"/>
                        <MenuItem Header="Edytuj ścieżkę / argumenty..." Click="EditShortcutPath_Click"/>
                        <MenuItem Header="Utwórz skrót na pulpicie" Click="CreateDesktopShortcut_Click"/>
                        <Separator Background="#444" Margin="0,5"/>
                        <MenuItem Header="Zmień nazwę..." Click="RenameSubShortcut_Click"/>
                        <MenuItem Header="Zmień ikonę..." Click="ChangeSubIcon_Click"/>
                        <MenuItem Header="Usuń" Click="DeleteSubShortcut_Click"/>
                        <Separator Background="#444" Margin="0,5"/>
                        <MenuItem Header="Właściwości" Click="ShowNativeProperties_Click"/>
                    </ContextMenu>
                </Button.ContextMenu>
                <Button.ToolTip>
                    <ToolTip Content="{Binding Name}" Background="#333" Foreground="White" BorderBrush="#555"/>
                </Button.ToolTip>
                <StackPanel>
                    <Image Source="{Binding IconPath, IsAsync=True}" 
                           Width="{Binding DataContext.SubIconSize, RelativeSource={RelativeSource AncestorType=Window}}" 
                           Height="{Binding DataContext.SubIconSize, RelativeSource={RelativeSource AncestorType=Window}}"
                           RenderOptions.BitmapScalingMode="HighQuality"/>
                </StackPanel>
            </Button>
        </DataTemplate>

        <DataTemplate x:Key="ListViewTemplate">
            <Button Click="SubAppButton_Click"
                    PreviewMouseLeftButtonDown="SubAppButton_PreviewMouseLeftButtonDown"
                    PreviewMouseMove="SubAppButton_PreviewMouseMove"
                    DragOver="SubAppButton_DragOver"
                    Drop="SubAppButton_Drop"
                    AllowDrop="True"
                    Margin="2"
                    HorizontalContentAlignment="Left"
                    Background="Transparent"
                    BorderBrush="Transparent"
                    ToolTipService.IsEnabled="False">
                <Button.ContextMenu>
                    <ContextMenu>
                        <MenuItem Header="Uruchom" Click="SubAppButton_Click"/>
                        <MenuItem Header="Uruchom jako Administrator" Click="RunAsAdmin_Click"/>
                        <Separator Background="#444" Margin="0,5"/>
                        <MenuItem Header="Otwórz lokalizację pliku" Click="OpenFileLocation_Click"/>
                        <MenuItem Header="Edytuj ścieżkę / argumenty..." Click="EditShortcutPath_Click"/>
                        <MenuItem Header="Utwórz skrót na pulpicie" Click="CreateDesktopShortcut_Click"/>
                        <Separator Background="#444" Margin="0,5"/>
                        <MenuItem Header="Zmień nazwę..." Click="RenameSubShortcut_Click"/>
                        <MenuItem Header="Zmień ikonę..." Click="ChangeSubIcon_Click"/>
                        <MenuItem Header="Usuń" Click="DeleteSubShortcut_Click"/>
                        <Separator Background="#444" Margin="0,5"/>
                        <MenuItem Header="Właściwości" Click="ShowNativeProperties_Click"/>
                    </ContextMenu>
                </Button.ContextMenu>

                <StackPanel Orientation="Horizontal" Width="{Binding DataContext.SubDockListWidth, RelativeSource={RelativeSource AncestorType=Window}}">
                    <Image Source="{Binding IconPath, IsAsync=True}" 
                           Width="24" 
                           Height="24"
                           Margin="5,2,10,2"
                           RenderOptions.BitmapScalingMode="HighQuality"/>
                    <TextBlock Text="{Binding Name}" 
                               Foreground="White" 
                               VerticalAlignment="Center"
                               FontSize="13"
                               TextTrimming="CharacterEllipsis"/>
                </StackPanel>
            </Button>
        </DataTemplate>
    </Window.Resources>

    <Border x:Name="MainBorder"
            Background="{Binding SubDockBackgroundBrush, RelativeSource={RelativeSource AncestorType=Window}}"
            CornerRadius="10" 
            Margin="5" 
            Padding="5,5" 
            AllowDrop="True"
            Drop="Window_Drop"
            MouseLeftButtonDown="Window_MouseLeftButtonDown">

        <Border.Style>
            <Style TargetType="Border">
            </Style>
        </Border.Style>

        <Border.Effect>
            <DropShadowEffect BlurRadius="15" ShadowDepth="5" Opacity="0.6"/>
        </Border.Effect>

        <Border.ContextMenu>
            <ContextMenu>
                <MenuItem Header="Dodaj skrót do folderu..." Click="AddFolderShortcut_Click"/>
                <Separator Background="#444" Margin="0,5"/>
                <MenuItem Header="Widok">
                    <MenuItem Header="Siatka (Ikony)" Tag="Grid" IsCheckable="True" Click="ChangeView_Click"
                              IsChecked="{Binding SubDockViewMode, Converter={x:Static local:EnumBooleanConverter.Instance}, ConverterParameter=Grid}"/>
                    <MenuItem Header="Lista (Szczegóły)" Tag="List" IsCheckable="True" Click="ChangeView_Click"
                              IsChecked="{Binding SubDockViewMode, Converter={x:Static local:EnumBooleanConverter.Instance}, ConverterParameter=List}"/>
                </MenuItem>
                <Separator Background="#444" Margin="0,5"/>
                <MenuItem Header="Zamknij grupę" Click="CloseGroup_Click"/>
            </ContextMenu>
        </Border.ContextMenu>

        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <Border Grid.Row="0"
                    Width="40" Height="4"
                    Background="White"
                    CornerRadius="2"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Top"
                    Opacity="0.4"
                    Margin="0,2,0,0">
                <Border.Effect>
                    <DropShadowEffect Color="White" BlurRadius="6" ShadowDepth="0" Opacity="0.6"/>
                </Border.Effect>
            </Border>

            <TextBlock Text="{Binding GroupData.Name, RelativeSource={RelativeSource AncestorType=Window}}"
                       Grid.Row="0"
                       Foreground="White"
                       FontSize="14"
                       FontWeight="SemiBold"
                       HorizontalAlignment="Center"
                       Margin="0,12,0,8" 
                       TextTrimming="CharacterEllipsis">
                <TextBlock.Effect>
                    <DropShadowEffect Color="Black" BlurRadius="4" ShadowDepth="2" Opacity="0.8"/>
                </TextBlock.Effect>
            </TextBlock>

            <ScrollViewer Grid.Row="1" 
                          VerticalScrollBarVisibility="Auto" 
                          HorizontalScrollBarVisibility="Disabled"
                          PanningMode="VerticalOnly"
                          Margin="0,5,0,0">

                <ItemsControl x:Name="SubItemsControl">
                    <ItemsControl.Style>
                        <Style TargetType="ItemsControl">
                            <Setter Property="ItemsPanel">
                                <Setter.Value>
                                    <ItemsPanelTemplate>
                                        <WrapPanel Orientation="Horizontal" Width="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=ScrollViewer}}"/>
                                    </ItemsPanelTemplate>
                                </Setter.Value>
                            </Setter>
                            <Setter Property="ItemTemplate" Value="{StaticResource GridViewTemplate}"/>

                            <Style.Triggers>
                                <DataTrigger Binding="{Binding SubDockViewMode}" Value="List">
                                    <Setter Property="ItemsPanel">
                                        <Setter.Value>
                                            <ItemsPanelTemplate>
                                                <StackPanel Orientation="Vertical"/>
                                            </ItemsPanelTemplate>
                                        </Setter.Value>
                                    </Setter>
                                    <Setter Property="ItemTemplate" Value="{StaticResource ListViewTemplate}"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </ItemsControl.Style>
                </ItemsControl>
            </ScrollViewer>

            <Thumb Grid.Row="1"
                   HorizontalAlignment="Right"
                   VerticalAlignment="Bottom"
                   Width="15" Height="15"
                   Margin="0,0,2,2"
                   DragDelta="ResizeGrip_DragDelta"
                   Cursor="SizeNWSE">
                <Thumb.Template>
                    <ControlTemplate>
                        <Grid Background="Transparent">
                            <Path Data="M 10,10 L 10,0 L 0,10 Z" Fill="#88FFFFFF" HorizontalAlignment="Right" VerticalAlignment="Bottom"/>
                        </Grid>
                    </ControlTemplate>
                </Thumb.Template>
            </Thumb>
        </Grid>
    </Border>
</Window>